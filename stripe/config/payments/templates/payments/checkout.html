{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stripe Checkout Demo</title>
    <link rel="stylesheet" href="{% static 'payments/styles.css' %}">
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
<main class="container">
    <header>
        <h1>Stripe Checkout</h1>
        <p>Демонстрация интеграции с оплатой через Stripe Checkout.</p>
    </header>

    {% if setup_incomplete %}
        <section class="card warning">
            <h2>Нужно настроить переменные окружения</h2>
            <p>Добавьте ключи Stripe и идентификатор Price в .env перед запуском.</p>
        </section>
    {% else %}
        <section class="card">
            <h2>Демо продукт</h2>
            <p>Оплатите один товар, оформленный как Price в Stripe Dashboard.</p>
            <button id="checkout-button">Перейти к оплате</button>
            <p id="error-message" class="error" hidden></p>
        </section>
    {% endif %}

    <section class="card secondary">
        <h3>Как это работает</h3>
        <ol>
            <li>Нажмите кнопку «Перейти к оплате».</li>
            <li>Мы создадим Checkout Session на бэкенде.</li>
            <li>Stripe возьмет на себя ввод карты и возврат результата.</li>
        </ol>
    </section>
</main>

{% if not setup_incomplete %}
    <form id="csrf-form">{% csrf_token %}</form>
    <script>
        const stripe = Stripe('{{ stripe_publishable_key }}');
        const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;
        const errorEl = document.getElementById('error-message');

        document.getElementById('checkout-button').addEventListener('click', async () => {
            errorEl.hidden = true;
            errorEl.textContent = '';

            try {
                const response = await fetch("{% url 'payments:create_checkout_session' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Неизвестная ошибка');
                }

                const result = await stripe.redirectToCheckout({sessionId: data.sessionId});

                if (result.error) {
                    throw result.error;
                }
            } catch (error) {
                errorEl.textContent = error.message || 'Не удалось создать сессию оплаты.';
                errorEl.hidden = false;
            }
        });
    </script>
{% endif %}
</body>
</html>

